package com.stevenfu.warehouse.network;

import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.os.Looper;
import android.util.Log;
import android.widget.Toast;

import com.stevenfu.warehouse.settings.Url;

import org.json.JSONException;
import org.json.JSONObject;

import java.io.BufferedReader;
import java.io.ByteArrayOutputStream;
import java.io.DataOutputStream;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;

/**
 * Created by Steven Fu on 12/05/2016.
 */

public class UploadFile {
    public UploadFile()
    {
        /*
        *
        * {"Id":"12","UserId":"1","FileName":"1480924574.jpg","FileType":"image\/jpeg","FilePath":"\/var\/www\/html\/uploads\/","FullPath":"\/var\/www\/html\/uploads\/1480924574.jpg","RawName":"1480924574","FileExt":".jpg","FileSize":"66.32","IsImage":"1","ImageWidth":"533.00","ImageHeight":"796.00","link":"http:\/\/g.thoughts-go.top\/uploads\/1480924574.jpg"}
        * {"error":"<p>The filetype you are attempting to upload is not allowed.<\/p>",
        * "files":{"uploadFile":{"name":"71cf3bc79f3df8dcd227017cc911728b461028c0.jpg","type":"multipart\/form-data","tmp_name":"D:\\xampp563\\tmp\\phpCEE6.tmp","error":0,"size":247059}}}
        *
        * */

    }

    public void DoTask(String filename){
        final List<String> uploadFiles = new ArrayList<>();
        uploadFiles.add(filename);
        JSONObject json  =new JSONObject();

        final String url = Url.SERVER_URL + Url.UPLOAD_FILE; //"http://10.4.30.60:8000/warehouse/Uploadfile/post";
        final Map<String, String> params = new HashMap<>();
        params.put("userId", "" + 1);
        params.put("jsonData", json.toString());

        HashSet<String> hashSet = new HashSet<>(uploadFiles);
        uploadFiles.clear();
        uploadFiles.addAll(hashSet);

        new Thread(new Runnable() {
            @Override
            public void run() {
                Looper.prepare();
                uploadFiles(url, params, uploadFiles.toArray(new String[0]), new IUploadPictureCallBack() {
                    @Override
                    public void callback(boolean successfully, String result) {
                        Log.d("Json",result);
                    }
                });
                Looper.loop();
            }
        }).start();
    }
    public static void uploadFiles(String actionUrl, Map<String, String> params, String[] uploadFiles, IUploadPictureCallBack callBack) {
        String BOUNDARY = java.util.UUID.randomUUID().toString();
        String PREFIX = "--", LINEND = "\r\n";
        String MULTIPART_FROM_DATA = "multipart/form-data";
        String CHARSET = "UTF-8";
        try {
            URL uri = new URL(actionUrl);
            HttpURLConnection conn = (HttpURLConnection) uri.openConnection();
            conn.setReadTimeout(20 * 1000);
            conn.setDoInput(true);// 允许输入
            conn.setDoOutput(true);// 允许输出
            conn.setUseCaches(false);
            conn.setRequestMethod("POST"); // Post方式
            conn.setRequestProperty("connection", "keep-alive");
            conn.setRequestProperty("Charset", CHARSET);
            conn.setRequestProperty("Content-Type", MULTIPART_FROM_DATA
                    + ";boundary=" + BOUNDARY);
            // 首先组拼文本类型的参数
            StringBuilder sb = new StringBuilder();
            for (Map.Entry<String, String> entry : params.entrySet()) {
                sb.append(PREFIX);
                sb.append(BOUNDARY);
                sb.append(LINEND);
                sb.append("Content-Disposition: form-data; name=\""
                        + entry.getKey() + "\"" + LINEND);
                sb.append("Content-Type: text/plain; charset=" + CHARSET + LINEND);
                sb.append("Content-Transfer-Encoding: 8bit" + LINEND);
                sb.append(LINEND);
                sb.append(entry.getValue());
                sb.append(LINEND);
            }
            DataOutputStream outStream = new DataOutputStream(
                    conn.getOutputStream());
            outStream.write(sb.toString().getBytes());

            if (uploadFiles != null && uploadFiles.length > 0) {
                for (String uploadFile : uploadFiles) {
                    StringBuilder sb1 = new StringBuilder();
                    sb1.append(PREFIX);
                    sb1.append(BOUNDARY);
                    sb1.append(LINEND);
                    String filename = "uploadFile";
                    String contentType = "image/jpeg";//"multipart/form-data";
                    sb1.append("Content-Disposition: form-data; name=\"" + filename + "\"; filename=\""
                            + uploadFile + "\"" + LINEND);
                    sb1.append("Content-Type: "+contentType+"; charset="
                            + CHARSET + LINEND);
                    sb1.append(LINEND);
                    outStream.write(sb1.toString().getBytes());

                    InputStream is = new FileInputStream(uploadFile);
                    byte[] buffer = new byte[1024];
                    int len = 0;
                    while ((len = is.read(buffer)) != -1) {
                        outStream.write(buffer, 0, len);
                    }
                    is.close();
                    outStream.write(LINEND.getBytes());
                }
            }

            // 请求结束标志
            byte[] end_data = (PREFIX + BOUNDARY + PREFIX + LINEND).getBytes();
            outStream.write(end_data);
            outStream.flush();
            // 得到响应码
            boolean success = conn.getResponseCode() == 200;
            InputStream in = conn.getInputStream();
            InputStreamReader isReader = new InputStreamReader(in);
            BufferedReader bufReader = new BufferedReader(isReader);
            String line = null;
//            String data = "getResult=";
            String data = "";
            while ((line = bufReader.readLine()) != null)
                data += line;

            outStream.close();
            conn.disconnect();

            if (callBack != null) {
                callBack.callback(success, data);
            }
        } catch (Exception e) {
            if (callBack != null) {
                callBack.callback(false, "");
            }
        }
    }

    public interface IUploadPictureCallBack {
        void callback(boolean successfully, String result);
    }
    public static byte[] decodeBitmap(String path) {
        BitmapFactory.Options opts = new BitmapFactory.Options();
        opts.inJustDecodeBounds = true;// 设置成了true,不占用内存，只获取bitmap宽高
        BitmapFactory.decodeFile(path, opts);
        opts.inSampleSize = computeSampleSize(opts, -1, 1024 * 800);
        opts.inJustDecodeBounds = false;// 这里一定要将其设置回false，因为之前我们将其设置成了true
        opts.inPurgeable = true;
        opts.inInputShareable = true;
        opts.inDither = false;
        opts.inPurgeable = true;
        opts.inTempStorage = new byte[16 * 1024];
        FileInputStream is = null;
        Bitmap bmp = null;
        ByteArrayOutputStream baos = null;
        try {
            is = new FileInputStream(path);
            bmp = BitmapFactory.decodeFileDescriptor(is.getFD(), null, opts);
            double scale = getScaling(opts.outWidth * opts.outHeight,
                    1024 * 600);
            Bitmap bmp2 = Bitmap.createScaledBitmap(bmp,
                    (int) (opts.outWidth * scale),
                    (int) (opts.outHeight * scale), true);
            bmp.recycle();
            baos = new ByteArrayOutputStream();
            bmp2.compress(Bitmap.CompressFormat.JPEG, 100, baos);
            bmp2.recycle();
            return baos.toByteArray();
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            try {
                is.close();
                baos.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
            System.gc();
        }
        return baos.toByteArray();
    }
    private static double getScaling(int src, int des) {
        /**
         * 48 目标尺寸÷原尺寸 sqrt开方，得出宽高百分比 49
         */
        double scale = Math.sqrt((double) des / (double) src);
        return scale;
    }
    public static int computeSampleSize(BitmapFactory.Options options,
                                        int minSideLength, int maxNumOfPixels) {
        int initialSize = computeInitialSampleSize(options, minSideLength,
                maxNumOfPixels);

        int roundedSize;
        if (initialSize <= 8) {
            roundedSize = 1;
            while (roundedSize < initialSize) {
                roundedSize <<= 1;
            }
        } else {
            roundedSize = (initialSize + 7) / 8 * 8;
        }

        return roundedSize;
    }

    private static int computeInitialSampleSize(BitmapFactory.Options options,
                                                int minSideLength, int maxNumOfPixels) {
        double w = options.outWidth;
        double h = options.outHeight;

        int lowerBound = (maxNumOfPixels == -1) ? 1 : (int) Math.ceil(Math
                .sqrt(w * h / maxNumOfPixels));
        int upperBound = (minSideLength == -1) ? 128 : (int) Math.min(
                Math.floor(w / minSideLength), Math.floor(h / minSideLength));

        if (upperBound < lowerBound) {
            return lowerBound;
        }

        if ((maxNumOfPixels == -1) && (minSideLength == -1)) {
            return 1;
        } else if (minSideLength == -1) {
            return lowerBound;
        } else {
            return upperBound;
        }
    }
}
